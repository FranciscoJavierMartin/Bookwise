// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String  @id
  name          String
  email         String  @unique
  emailVerified Boolean @default(false)
  image         String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sessions Session[]
  accounts Account[]

  booksCreated      Book[]               @relation("BooksCreatedByUser")
  reviews           BookReview[]
  favorites         Favorite[]
  readingHistories  UserReadingHistory[]
  adminActivityLogs AdminActivityLog[]

  @@map("User")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  ipAddress String?
  userAgent String?
  userId    String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([userId])
  @@map("Session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // subscriptionTier      SubscriptionTier   @default(FREE)
  // subscriptionStatus    SubscriptionStatus @default(INACTIVE)
  // subscriptionStartDate DateTime?
  // subscriptionEndDate   DateTime?
  audioListenTime Int @default(0)

  @@index([userId])
  @@map("Account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([identifier])
  @@map("Verification")
}

model Category {
  id           String  @id @default(cuid())
  name         String  @unique
  slug         String  @unique
  description  String? @db.Text
  icon         String? // icon name or URL
  displayOrder Int     @default(0)
  isActive     Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  books Book[]
}

model Book {
  id                 String  @id @default(cuid())
  title              String
  slug               String  @unique
  author             String
  description        String? @db.Text
  coverImageurl      String?
  originalPdfUrl     String?
  originalPdfPath    String?
  publicationYear    Int?
  ISBN               String?
  readingTimeMinutes Int     @default(15)
  totalAudioDuration Int     @default(0)
  averageRating      Decimal @default(0.00) @db.Decimal(3, 2)
  totalReviews       Int     @default(0)
  viewCount          Int     @default(0)
  isFeatured         Boolean @default(false)
  isPublished        Boolean @default(false)
  summaryGenerated   Boolean @default(false)
  audioGenerated     Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  category         Category             @relation(fields: [categoryId], references: [id])
  categoryId       String
  createdBy        User                 @relation("BooksCreatedByUser", fields: [createdById], references: [id])
  createdById      String
  summary          BookSummary?
  chapters         BookChapter[]
  reviews          BookReview[]
  favorites        Favorite[]
  readingHistories UserReadingHistory[]

  @@index([slug])
  @@index([categoryId])
  @@index([createdById])
}

model BookSummary {
  id              String  @id @default(cuid())
  mainSummary     String? @db.Text
  keyTakeaways    Json?
  fullSummary     String? @db.Text
  tableOfContents Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  book   Book   @relation(fields: [bookId], references: [id], onDelete: Cascade)
  bookId String @unique
}

model BookChapter {
  id             String  @id @default(cuid())
  chapterNumber  Int
  chapterTitle   String
  chapterSummary String? @db.Text
  audioUrl       String?
  audioDuration  Int     @default(0)
  displayOrder   Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  book   Book   @relation(fields: [bookId], references: [id], onDelete: Cascade)
  bookId String

  @@index([bookId])
}

model BookReview {
  id                 String  @id @default(cuid())
  rating             Int     @db.SmallInt
  reviewTitle        String?
  reviewText         String  @db.Text
  isVerifiedPurchase Boolean @default(false)
  isApproved         Boolean @default(true)
  helpfulCount       Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User?   @relation(fields: [userId], references: [id])
  userId String?
  book   Book?   @relation(fields: [bookId], references: [id])
  bookId String?
}

model Favorite {
  createdAt DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String
  book   Book   @relation(fields: [bookId], references: [id], onDelete: Cascade)
  bookId String

  @@id([userId, bookId])
  @@index([userId])
  @@index([bookId])
}

model UserReadingHistory {
  lastAccessed         DateTime @default(now())
  completionPercentage Int      @default(0)
  audioPosition        Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String
  book   Book   @relation(fields: [bookId], references: [id], onDelete: Cascade)
  bookId String

  @@id([userId, bookId])
  @@index([userId])
  @@index([bookId])
}

model AdminActivityLog {
  id          String  @id @default(cuid())
  actionType  String
  targetType  String // 'book', 'category', 'user', etc.
  targetId    String?
  description String? @db.Text
  ipAddress   String?

  createdAt DateTime @default(now())

  admin   User   @relation(fields: [adminId], references: [id])
  adminId String

  @@index([adminId])
}

model SystemSetting {
  id           String      @id @default(cuid())
  settingKey   String
  settingValue String
  settingType  SettingType
  description  String?     @db.Text

  updatedAt DateTime @updatedAt
}

// Maybe needs to be removed later
// model SubscriptionPlan {
//   id           String      @id @default(cuid())
//   planName     String
//   renewalType  RenewalType
//   price        Decimal     @db.Decimal(10, 2)
//   features     Json?
//   isActive     Boolean     @default(true)
//   displayOrder Int         @default(0)

//   createdAt DateTime @default(now())
//   updatedAt DateTime @updatedAt
// }

// enum SubscriptionTier {
//   FREE
//   MONTHLY
//   YEARLY
//   LIFETIME
// }

// enum SubscriptionStatus {
//   ACTIVE
//   INACTIVE
//   EXPIRED
//   CANCELLED
// }

// enum RenewalType {
//   MONTHLY
//   YEARLY
//   LIFETIME
// }

enum SettingType {
  STRING
  NUMBER
  BOOLEAN
  JSON
}
